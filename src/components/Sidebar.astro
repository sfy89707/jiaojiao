---
import { getCollection } from 'astro:content';

const BASE = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const recent = posts.slice(0, 6);
const tagSet = new Set<string>();
for (const p of posts) {
	for (const t of p.data.tags ?? []) tagSet.add(t);
}
const tags = Array.from(tagSet).sort((a, b) => a.localeCompare(b, 'zh-CN'));
---

<aside class="sidebar">
	<section class="card profile">
		<img class="avatar" src={`${BASE}images/jiaojiao-cutout.png?v=2`} alt="叫叫（金渐层）" loading="lazy" />
		<div>
			<div class="name">叫叫</div>
			<div class="bio">欢迎来到叫叫站，我是一直可爱的金渐层小猫咪</div>
			<div class="links">
				<a href="https://github.com/sfy89707" target="_blank" rel="noreferrer">GitHub</a>
				<a href="mailto:1046020610@qq.com">邮箱</a>
			</div>
		</div>
	</section>

	<section class="card">
		<div class="card-title">搜索</div>
		<input id="post-search" class="search" type="search" placeholder="搜索标题/简介…" />
		<div class="hint">在“文章”页会自动过滤列表</div>
	</section>

	<section class="card">
		<div class="card-title">标签</div>
		<div class="tags">
			{tags.length ? (
				tags.map((t) => (
					<a class="tag" href={`${BASE}blog?tag=${encodeURIComponent(t)}`}>{t}</a>
				))
			) : (
				<span class="muted">暂无标签</span>
			)}
		</div>
	</section>

	<section class="card">
		<div class="card-title">归档</div>
		<a class="archive" href={`${BASE}archive`}>按月份查看 →</a>
	</section>

	<section class="card">
		<div class="card-title">最近更新</div>
		<ul class="recent">
			{recent.map((p) => (
				<li>
					<a href={`${BASE}blog/${p.id}/`}>{p.data.title}</a>
				</li>
			))}
		</ul>
	</section>
</aside>

<style>
	.sidebar { position: sticky; top: 72px; align-self: start; }
	.card {
		background: var(--card);
		border: 1px solid var(--border);
		border-radius: 16px;
		box-shadow: var(--shadow);
		backdrop-filter: blur(12px);
		padding: 1rem;
		margin-bottom: 1rem;
	}
	.profile { display: flex; gap: .9rem; align-items: center; }
	.avatar {
		width: 44px;
		height: 44px;
		border-radius: 50%;
		object-fit: cover;
		border: 1px solid rgba(0,0,0,.08);
	}
	.name { font-weight: 800; color: rgb(var(--black)); }
	.bio { color: rgb(var(--gray)); font-size: .92rem; margin-top: .2rem; }
	.links { margin-top: .35rem; display:flex; gap: .6rem; font-size: .92rem; }
	.card-title { font-weight: 800; margin-bottom: .6rem; color: rgb(var(--black)); }
	.search {
		width: 100%; padding: .6rem .7rem; border-radius: 10px;
		border: 1px solid rgb(var(--gray-light)); outline: none;
	}
	.hint { margin-top: .5rem; font-size: .85rem; color: rgb(var(--gray)); }
	.tags { display:flex; flex-wrap: wrap; gap: .5rem; }
	.tag {
		padding: .3rem .55rem; border-radius: 999px;
		background: rgba(14,165,233,.10);
		text-decoration:none;
		font-size: .9rem;
	}
	.archive { text-decoration:none; color: rgb(var(--black)); font-weight: 800; }
	.archive:hover { color: var(--accent-dark); }
	.recent { list-style: none; margin: 0; padding: 0; display:grid; gap: .45rem; }
	.recent a { text-decoration: none; }
	.muted { color: rgb(var(--gray)); }
</style>

<script>
	const input = document.getElementById('post-search');
	if (input) {
		const saved = sessionStorage.getItem('postSearch') || '';
		input.value = saved;
		input.addEventListener('input', (e) => {
			const v = e.target.value || '';
			sessionStorage.setItem('postSearch', v);
			window.dispatchEvent(new CustomEvent('post-search', { detail: v }));
		});
	}
</script>
