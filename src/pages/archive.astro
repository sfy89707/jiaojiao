---
import { getCollection } from 'astro:content';
import SiteLayout from '../layouts/SiteLayout.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

const BASE = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

function ym(d: Date) {
	const y = d.getFullYear();
	const m = String(d.getMonth() + 1).padStart(2, '0');
	return `${y}-${m}`;
}

const groups = new Map<string, typeof posts>();
for (const p of posts) {
	const key = ym(p.data.pubDate);
	const arr = groups.get(key) || [];
	arr.push(p);
	groups.set(key, arr);
}

const keys = Array.from(groups.keys()).sort((a, b) => (a < b ? 1 : -1));
---

<SiteLayout title={`${SITE_TITLE} · 归档`} description={SITE_DESCRIPTION}>
	<h1>归档</h1>
	<p class="sub">按月份整理文章，方便快速回看。</p>

	{keys.map((k) => (
		<section class="group">
			<h2>{k}</h2>
			<ul>
				{(groups.get(k) || []).map((p) => (
					<li>
						<a href={`${BASE}blog/${p.id}/`}>{p.data.title}</a>
						<span class="meta">{p.data.description}</span>
					</li>
				))}
			</ul>
		</section>
	))}

	<style>
		.sub { color: rgb(var(--gray)); margin-top: .2rem; }
		.group { margin-top: 1.4rem; }
		h2 { font-size: 1.25rem; margin-bottom: .6rem; }
		ul { list-style: none; padding: 0; margin: 0; display: grid; gap: .5rem; }
		li {
			background: #fff;
			border-radius: 12px;
			box-shadow: var(--box-shadow);
			padding: .7rem .9rem;
			display: grid;
			gap: .25rem;
		}
		li a { font-weight: 900; text-decoration: none; color: rgb(var(--black)); }
		.meta { color: rgb(var(--gray)); font-size: .92rem; }
	</style>
</SiteLayout>
